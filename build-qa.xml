<?xml version="1.0" encoding="UTF-8"?>
<project name="vantomas-qa" default="help">

	<target name="help">
		<echo>
			You can't run this file directly. It is intended to be included
			within the main build file build.xml.
		</echo>
	</target>

	<target name="qa:prepare" unless="releasing">
		<mkdir dir="${project.basedir}/build/phpunit-coverage" />
	</target>

	<target
		name="qa:phpmd"
		description="Runs phpmd on src/"
		depends="qa:prepare"
		unless="releasing">

		<exec
			executable="/usr/bin/env"
			checkreturn="false"
			passthru="true">

			<arg value="php" />
			<arg value="./vendor/bin/phpmd" />
			<arg value="./src/vantomas/Classes/" />
			<arg value="xml" />
			<arg value="codesize,unusedcode,naming,design" />
			<arg line="--reportfile ./build/phpmd.xml" />
			<arg line="--suffixes php" />
		</exec>
	</target>

	<target
		name="qa:pdepend"
		description="Runs pdepend on src/"
		depends="qa:prepare"
		unless="releasing">

		<exec
			executable="/usr/bin/env"
			checkreturn="false"
			passthru="true">

			<arg value="php" />
			<arg value="./vendor/bin/pdepend" />
			<arg line="--jdepend-chart=./build/jdepend.svg" />
			<arg line="--jdepend-xml=./build/jdepend.xml" />
			<arg line="--overview-pyramid=./build/jdepend-pyramid.svg" />
			<arg line="--summary-xml=./build/pdepend-summary.xml" />
			<arg line="--suffix=php" />
			<arg value="./src/vantomas/Classes/" />
		</exec>
	</target>

	<target
		name="qa:phploc"
		description="Runs phploc on src/"
		depends="qa:prepare"
		unless="releasing">

		<exec
			executable="/usr/bin/env"
			checkreturn="false"
			passthru="true">

			<arg value="php" />
			<arg value="${project.basedir}/vendor/bin/phploc" />
			<arg line="--names=*.php" />
			<arg line="--log-csv=${project.basedir}/build/phploc.csv" />
			<arg line="--log-xml=${project.basedir}/build/phploc.xml" />
			<arg line="--progress " />
			<arg value="${project.basedir}/src/" />
		</exec>
	</target>

	<target
		name="qa:phpcpd"
		description="Runs phpcpd on src/"
		depends="qa:prepare"
		unless="releasing">

		<exec
			executable="/usr/bin/env"
			checkreturn="false"
			passthru="true">

			<arg value="php" />
			<arg value="${project.basedir}/vendor/bin/phpcpd" />
			<arg line="--names=*.php" />
			<arg line="--names-exclude=ext_emconf.php,ext_localconf.php,ext_tables.php" />
			<arg line="--log-pmd=${project.basedir}/build/phpcpd.xml" />
			<arg line="--progress" />
			<arg value="./src/" />
		</exec>
	</target>

	<target
		name="qa:phpcs"
		description="Runs phpcs on src/"
		depends="qa:prepare"
		unless="releasing">

		<exec
			executable="/usr/bin/env"
			checkreturn="false"
			passthru="true">

			<arg value="php" />
			<arg value="${project.basedir}/vendor/bin/phpcs" />
			<arg line="-np" />
			<arg line="--report=checkstyle" />
			<arg line="--report-checkstyle=${project.basedir}/build/phpcs-checkstyle.xml" />
			<arg line="--standard=TYPO3CMS" />
			<arg line="--ignore=**/vendor/**" />
			<arg line="-d error_reporting='E_ALL &amp; ~E_NOTICE &amp; ~E_STRICT &amp; ~E_DEPRECATED'" />
			<arg line="--extensions=php" />
			<arg value="${project.basedir}/src/" />
		</exec>
	</target>

	<target
		name="qa:phpunit"
		description="Runs phpunit on src/"
		depends="qa:prepare"
		unless="releasing">

		<exec
			executable="/usr/bin/env"
			checkreturn="true"
			passthru="true">

			<arg value="php" />
			<arg value="${project.basedir}/vendor/bin/phpunit" />
			<arg line="-c ${project.basedir}/phpunit.dist.xml" />
		</exec>
	</target>

	<target
		name="qa"
		description="Runs the QA toolchain"
		depends="qa:phpmd, qa:pdepend, qa:phploc, qa:phpcpd, qa:phpcs, qa:phpunit"
		unless="releasing">

		<echo>QA toolchain ready.</echo>
	</target>
</project>