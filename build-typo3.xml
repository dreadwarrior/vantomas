<?xml version="1.0" encoding="UTF-8"?>
<project name="vantomas-typo3" default="help">

	<target name="help" hidden="true">
		<echo>
			You can't run this file directly. It is intended to be included
			within the main build file build.xml.
		</echo>
	</target>

	<target
		name="typo3:prepare"
		description="Prepares the TYPO3.CMS directory structure for user data">

		<mkdir dir="${distDir}/fileadmin/user_upload" />
		<mkdir dir="${distDir}/typo3conf/ext" />
		<mkdir dir="${distDir}/typo3conf/l10n" />
		<mkdir dir="${distDir}/typo3temp" />
		<mkdir dir="${distDir}/uploads/media" />
		<mkdir dir="${distDir}/uploads/pics" />
	</target>

	<target
		name="typo3:copy-core"
		description="Copies the TYPO3 core into the release directory."
		depends="typo3:prepare">

		<copy todir="${distDir}" overwrite="true">
			<fileset dir="./vendor/typo3/cms/">
				<include name="typo3/**" />
				<include name="index.php" />

				<exclude name="**/.git*" />
				<exclude name="**/Tests/**" />
			</fileset>
		</copy>
	</target>

	<target
		name="typo3:copy-vendor-extensions"
		description="Copies the vendor extension into the typo3conf/ext/ release directory"
		depends="typo3:prepare">

		<copy todir="${distDir}/typo3conf/ext">
			<fileset dir="./vendor/typo3-cms-extension">
				<include name="**/**" />

				<exclude name="**/.git*" />
				<exclude name="**/Tests/**" />
			</fileset>
		</copy>
	</target>

	<target
		name="typo3:copy-project-extensions"
		description="Copies the project extensions into the typo3conf/ext/ release directory"
		depends="typo3:prepare">

		<copy todir="src/" overwrite="true">
			<mapper type="regexp" from="^(.*)\.tpl\.(.*)" to="\1.\2" />
			<filterchain>
				<expandproperties />
			</filterchain>

			<fileset dir="./src">
				<include name="**/**" />

				<exclude name="**/.git*" />
				<exclude name="**/Tests/**" />
			</fileset>
		</copy>

		<exec
			command="/usr/bin/env grunt build"
			passthru="true"
			checkreturn="true" />

		<copy todir="${distDir}/typo3conf/ext" overwrite="true">
			<fileset dir="./src">
				<include name="**/**" />

				<exclude name="**/.git*" />
				<exclude name="**/*.tpl.*" />
				<exclude name="**/Tests/**" />
			</fileset>
		</copy>
	</target>

	<target
		name="typo3:copy-extensions"
		description="Copies the extensions into typo3conf/ext/ release directory"
		depends="typo3:copy-vendor-extensions, typo3:copy-project-extensions">

		<echo>Extensions copied.</echo>
	</target>
</project>